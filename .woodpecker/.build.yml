labels:
  platform: linux/amd64

steps:
  - name: build
    image: docker
    environment:
      FORGEJO_REGISTRY_URL:
        from_secret: FORGEJO_REGISTRY_URL
      FORGEJO_REGISTRY_USERNAME:
        from_secret: FORGEJO_REGISTRY_USERNAME
      FORGEJO_REGISTRY_PASSWORD:
        from_secret: FORGEJO_REGISTRY_PASSWORD
      REGISTRY_IMAGE_TAG:
        from_secret: REGISTRY_IMAGE_TAG
    commands:
      - docker build -t "$REGISTRY_IMAGE_TAG" .
      - echo "$FORGEJO_REGISTRY_PASSWORD" | docker login "$FORGEJO_REGISTRY_URL" --password-stdin -u "$FORGEJO_REGISTRY_USERNAME"
      - docker push "$REGISTRY_IMAGE_TAG"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      - branch: master
        event: push
  - name: ntfy
    image: codeberg.org/l-x/woodpecker-ntfy
    when:
      - event: push
    settings:
      url:
        from_secret: NTFY_URL
      title: >
        {{#success build.status}}
        Blog image build succeeded
        {{else}}
        Blog image build failed
        {{/success}}
      priority: urgent
      click: https://blog.06222001.xyz
      icon: https://blog.06222001.xyz/img/logo.svg
      tags: robot,${CI_REPO_NAME}
      message: ${CI_COMMIT_MESSAGE}

when:
  - branch: master
    event: push
